---
#
# Copyright (c) 2024 Wind River Systems, Inc.
#
# SPDX-License-Identifier: Apache-2.0
#
# ROLE DESCRIPTION:
#   This role is to enable and configure IPSec on all hosts
#   per the execution of initial-auth operation.
#

- name: Get system mode
  shell: source /etc/platform/platform.conf; echo $system_mode
  register: system_mode

- block:
  - name: Get PXEBoot network addresses list of pending hosts
    script: roles/configure-ipsec/files/get_ipsec_disabled_addr_list.py
    register: pending_hosts
    become_user: postgres

  - name: Get PXEBoot network list addresses
    script: roles/common/files/get_pxeboot_addr_list.py
    register: ip_addrs_list

  - set_fact:
      retry_count: 0
      failures_list: []
      pending_hosts: "{{ pending_hosts.stdout }}"
      pxeboot_addrs: "{{ ip_addrs_list.stdout }}"

  # It is found that when enabling IPsec, if the active controller is enabled before
  # worker node, worker node will no longer have the shared FS (/opt/platform) mounted,
  # the ipsec-client command will hang forever. Further investigation shows the
  # puppet apply invoked by ipsec-client is blocked at resolving "file system" facts,
  # and strace shows statfs() system call is blocked on the shared FS (/opt/platform).
  # The solution here is to create a facter.conf file to exclude "file system" fact
  # resolving for puppet apply.
  - name: Create facter.conf to exclude "file system" fact resolve in puppet apply
    command: >-
      ansible all -i "{{ item }}," -m shell -a "mkdir -p /etc/puppetlabs/facter &&
      echo -e \"facts : {\n  blocklist : [ \"file system\" ],\n}\" >
      /etc/puppetlabs/facter/facter.conf" -b -e "ansible_ssh_user={{ ansible_ssh_user }}
      ansible_ssh_pass={{ ansible_ssh_pass }} ansible_become_pass={{ ansible_become_pass }}"
    loop: "{{ pxeboot_addrs }}"

  - name: Execute initial-auth operation on hosts
    include_tasks: execute-initial-auth-operation.yml
    when: 'pending_hosts | length > 0'

  - name: Get MGMT network addresses list
    script: roles/configure-ipsec/files/get_all_mgmt_addrs.py
    register: all_hosts
    become_user: postgres

  - set_fact:
      all_hosts: "{{ all_hosts.stdout }}"

  # Wait a maximum time of 3 minutes until hosts are reachable,
  # i.e. IPsec SAs are established between hosts.
  - name: Wait until hosts are online and reachable
    shell: "ping -c 1 -w 5 {{ item }} | grep ' 0% packet loss'"
    register: host_is_reachable
    loop: "{{ all_hosts | list }}"
    until: host_is_reachable is not failed
    retries: 18
    delay: 10

  - name: Start and provision ipsec-config service on controllers
    command: >-
      ansible all -i "{{ item }}," -m command -a "sm-provision service-group-member
      controller-services ipsec-config --apply" -b -e "ansible_ssh_user={{ ansible_ssh_user }}
      ansible_ssh_pass={{ ansible_ssh_pass }} ansible_become_pass={{ ansible_become_pass }}"
    with_items:
      - controller-0
      - controller-1

  - name: Remove the created facter.conf and directories
    command: >-
      ansible all -i "{{ item }}," -m command -a "rm -rf /etc/puppetlabs"
      -b -e "ansible_ssh_user={{ ansible_ssh_user }} ansible_ssh_pass={{ ansible_ssh_pass }}
      ansible_become_pass={{ ansible_become_pass }}"
    loop: "{{ pxeboot_addrs }}"

  when: system_mode.stdout != "simplex"
